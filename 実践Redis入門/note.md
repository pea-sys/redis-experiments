- Redis3.2 以降、保護モードが有効だとローカルホストからの接続に限定される。
- Redis6.0 以降、ACL によるアクセス制御が可能になっているが、インターネットからのアクセスを考慮した設計になっていない。

* keys コマンドはパフォーマンスが低いので、本番環境での使用は推奨しない。代わりに scan コマンドを使用する。

* string 型のサイズ上限のデフォルト値は 512MB。設定により変更可能。

* キーの命名は公式では以下を推奨している

  - 長すぎる名前は不適切(メモリ効率が悪い)
  - 短すぎる名前も多くの場合不適切(可読性が悪い)
  - スキーマ設計(区切り文字のルールを作り運用する。:,/)

* mset mget など複数キーを一括で扱えるコマンドのメリットはサーバとのやり取り回数を減らすことによるパフォーマンス向上

* 文字列の値を持つキーの値をセットする場合。ダブルクォーテーションを付けること（付けないとスペースが無視される）。

* set ~ nx は複数プロセスから単一の redis サーバーにアクセスする際に使用できそう。１対１の場合は素直に get（個人の感想）

* BLPOP および BRPOP を使用することで、リスト型はキューとして使える。他のコマンドを使用することでスタック等も作成できる。

* オブジェクトの管理にはハッシュ型推奨  
  特に要素数が少ない場合や要素の最大巣サイズが小さい場合は最適化された形式で保存されるため、メモリー効率が良い。逆にそのようにできない場合は String 型を利用する。

* Hash 型の\*keys 系コマンドは本番使用非推奨。代わりに\*SCAN 系を使用すること。

* サイズの大きいデータを del で消そうとするとブロッキングされるため、なるべく unlink で削除する。

* エフェメラルスクリプトは eval と evalsha がある。eval の場合、毎回 Lua スクリプトをサーバに送るのでオーバーヘッドがある。実運用では evalsha を使うことを推奨。

* Lua スクリプトは出来るだけ KEY 変数や ARGV 変数を使用し、直接値を埋め込まないこと。値を埋め込むと、スクリプトのパターンが増加しキャッシュに必要なメモリも増える。

* Redis で Lua を実行する方法として、Redis7.0 以上を使用する場合、エフェメラルスクリプトは使わずに Redis ファンクションを採用すること

* Redis で Lua を実行時、ブロッキングされるので長時間の処理は避けること。アトミックな処理をしないのであれば、ブロッキングしないパイプラインの方がパフォーマンスは良い。

* トランザクションは廃止される可能性があるので出来るだけ使用しない

* キー空間通知は実際にデータが変化したタイミングで通知が来る。TTL が切れても削除されなければ通知が来ない。

* String 型以外の型は使用方法によってスケーリングしない場合もままあるので、慎重に導入すること

* 通常 Redis に長期間データを保持する必要はないので、適切な TTL を設定すること

* バックアップのために Redis のために必要なメモリ容量の倍程度確保しておくこと

* コネクションプーリングを適切に使用すること。プーリングするコネクション数は設定できることも多い。

* ベンチマークツール

  - redis-benchmark
  - memtoer_benchmark
  - rpc-perf

* Redis はシングルスレッドではあるが、マルチプロセスにすることでマルチコアの恩恵は得られる

* Redis のデータベース機能の使用は公式非推奨

* レプリケーション時に読込みをスケーリングするためには読込先をレプリカに設定する

* ユーザー id とパスワードを同じにして認証しようとするとエラーになる

```
WRONGPASS invalid username-password pair or user is disabled.
```

---

- redis 型

| 型           | 説明                                                                                              | 利用例                                                 |
| ------------ | ------------------------------------------------------------------------------------------------- | ------------------------------------------------------ |
| String       | 最低単位のベーシックな型。数値や画像等何でも扱える。一般的な文字列型ではない。                    | キャッシュ/カウンター/セッション情報/画像/メトリクス等 |
| List         | String 型のリスト                                                                                 | スタック/キュー/ログ等                                 |
| Hash         | 順序性のない複数の対からなるデータ構造。辞書型。                                                  | オブジェクト表現等                                     |
| Set          | 順序性のない文字列型の集合                                                                        | メンバーシップ/タグ管理等                              |
| SortedSet    | 順序性のある文字列型の集合                                                                        | ランキング等                                           |
| Bitmap       | 2 値配列                                                                                          | リアルタイム分析/オブジェクト ID に紐づく二値情報      |
| HyperLogLog  | 湯ニーズ名 k 図を計算する確率的な計算手法。メモリーを効率的に使用できる反面、精度に誤差が生じる。 | ユニークな訪問者数                                     |
| Redis Stream | 連続的に大量に発生するデータに適した型。                                                          | チャット/キューイング/ログ等                           |

- RTT 削減

|                                  | MSET | パイプライン | トランザクション | エフェメラルスクリプト | RedisFunction | モジュール |
| -------------------------------- | ---- | ------------ | ---------------- | ---------------------- | ------------- | ---------- |
| RTT の削減                       | 〇   | 〇           | 〇               | 〇                     | 〇            | 〇         |
| 複数のデータ型のキーの同時扱い   | ×    | 〇           | 〇               | 〇                     | 〇            | 〇         |
| アトミック処理の有無             | 〇   | ×            | 〇               | 〇                     | 〇            | 〇         |
| ロジックの構築(if 文等)          | ×    | ×            | ×                | 〇                     | 〇            | 〇         |
| 処理途中で演算結果を利用         | ×    | ×            | ×                | 〇                     | 〇            | 〇         |
| コマンド群のサーバー内での耐久性 | ×    | ×            | ×                | △                      | 〇            | 〇         |
| 独自のデータ構造・コマンドの利用 | ×    | ×            | ×                | ×                      | ×             | 〇         |
| 3rd パーティライブラリの利用     | ×    | ×            | ×                | ×                      | ×             | 〇         |

---

### トラブルシューティングの切り分け視点

- 特定コマンドのみもしくは全体的にコマンドが遅くなっているか
- 特定のキャッシュノードのみもしくは全キャッシュノードで問題が発生しているか
- 特定のクライアントもしくは複数のクライアントでも事象が発生するか
- 継続的に発生するものかもしくは特定時間帯のみか
- 事象発生頻度はどの程度か

---

[参考 URL]

- [Redis 実装事例](https://launchpad.redis.com/)
- [推奨クライアント](https://redis.io/docs/clients/)

* [Reids の７つの悪習](https://redis.com/blog/7-redis-worst-practices/)
